---
import { transactions, accounts,activities } from "../../../models/schema";
import { db } from "../../../utils/db";
import { sum, eq } from "drizzle-orm";
import type { ApexOptions } from "apexcharts";
import BaseChart from "../../charts/BaseChart.astro";

// Fetch run records
const runRecords = await db
  .select({
    id: activities.id,
    date: activities.start_date,
    distance: activities.distance,
    time: activities.elapsed_time,
  })
  .from(activities)
  .execute();

// Prepare the series data for the line chart
const seriesDataDistance = runRecords.map(run => ({
  x: new Date(run.date).getTime(), // Convert date to timestamp
  y: run.distance
}));

const seriesDataTime = runRecords.map(run => ({
  x: new Date(run.date).getTime(), // Convert date to timestamp
  y: run.time
}));

// Chart options setup for dual-axis line chart
const chartOptions: ApexOptions = {
  series: [{
    name: "Distance (km)",
    data: seriesDataDistance,
    type: 'line'
  }, {
    name: "Time (min)",
    data: seriesDataTime,
    type: 'line'
  }],
  chart: {
    height: 350,
    type: "line",
    zoom: {
      enabled: true
    },
  },
  stroke: {
    width: 2,
    curve: 'smooth'
  },
  colors: ['#1f77b4', '#ff7f0e'], // Adjust colors to differentiate distance and time
  xaxis: {
    type: 'datetime',
    labels: {
      style: {
        colors: '#ffffff', // Adjust to your theme
      },
    },
  },
  yaxis: [{
    title: {
      text: 'Distance (km)',
      style: {
        color: '#1f77b4', // Adjust to your theme
      },
    },
    labels: {
      style: {
        colors: '#1f77b4', // Adjust to your theme
      },
    },
  }, {
    opposite: true,
    title: {
      text: 'Time (min)',
      style: {
        color: '#ff7f0e', // Adjust to your theme
      },
    },
    labels: {
      style: {
        colors: '#ff7f0e', // Adjust to your theme
      },
    },
  }],
  tooltip: {
    shared: true,
    intersect: false,
    y: {
      formatter: function(val) {
        return val.toFixed(2);
      }
    }
  },
  legend: {
    show: true,
    labels: {
      colors: '#ffffff', // Adjust to your theme
    },
  },
};
---
<BaseChart options={chartOptions} />
